<div class="admin3d-page-container">
  <div class="admin3d-page-header">
    <h1><i class="fas fa-chart-line"></i> Advanced Statistics</h1>
    <p>Real-time metrics and performance analytics for your Discord bot</p>
  </div>
  
  <!-- Visualization Mode Switcher -->
  <div class="visualization-mode-switcher">
    <button id="mode-3d" class="mode-btn active"><i class="fas fa-cube"></i> 3D Mode</button>
    <button id="mode-2d" class="mode-btn"><i class="fas fa-chart-bar"></i> 2D Mode</button>
  </div>

  <div class="stats-dashboard-container">
    <!-- Server Overview Section -->
    <div class="stats-card server-overview">
      <div class="stats-card-header">
        <h2>Server Overview</h2>
        <div class="stats-controls">
          <button id="refresh-stats-btn" class="btn btn-sm btn-primary">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <div class="time-selector">
            <button data-time="hour" class="time-btn active">1h</button>
            <button data-time="day" class="time-btn">24h</button>
            <button data-time="week" class="time-btn">7d</button>
            <button data-time="month" class="time-btn">30d</button>
          </div>
        </div>
      </div>
      <div class="stats-card-body">
        <div class="quick-stats">
          <div class="stat-item">
            <div class="stat-icon"><i class="fas fa-server"></i></div>
            <div class="stat-content">
              <h3><%= serverStats.servers %></h3>
              <p>Servers</p>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-content">
              <h3><%= serverStats.users.toLocaleString() %></h3>
              <p>Users</p>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon"><i class="fas fa-hashtag"></i></div>
            <div class="stat-content">
              <h3><%= serverStats.channels.toLocaleString() %></h3>
              <p>Channels</p>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-content">
              <h3><%= uptime.days %>d <%= uptime.hours %>h <%= uptime.minutes %>m</h3>
              <p>Uptime</p>
            </div>
          </div>
        </div>
        
        <!-- 3D Server Activity Graph -->
        <div class="graph-container">
          <div id="server-activity-3d" class="graph-3d-container"></div>
          <!-- 2D Fallback -->
          <div id="server-activity-2d" class="fallback-chart-container">
            <div class="fallback-message">
              <i class="fas fa-chart-line fa-2x"></i>
              <h3>Server Activity</h3>
              <p>Real-time visualization of server interactions and command usage</p>
              <div class="fallback-data">
                <div class="data-point">
                  <div class="label">Commands Today</div>
                  <div class="value">254</div>
                </div>
                <div class="data-point">
                  <div class="label">Active Users</div>
                  <div class="value">128</div>
                </div>
                <div class="data-point">
                  <div class="label">Peak Hour</div>
                  <div class="value">8PM</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- System Performance Section -->
    <div class="stats-row">
      <div class="stats-card system-performance">
        <div class="stats-card-header">
          <h2>System Performance</h2>
        </div>
        <div class="stats-card-body">
          <div class="performance-metrics">
            <div class="performance-item">
              <div class="metric-label">CPU Usage</div>
              <div class="metric-value" id="cpu-usage">0%</div>
              <div class="metric-progress">
                <div class="progress-bar" id="cpu-progress"></div>
              </div>
              <div class="metric-details">
                <span>Cores: <%= system.cpuCount %></span>
                <span>Arch: <%= system.arch %></span>
              </div>
            </div>
            
            <div class="performance-item">
              <div class="metric-label">Memory Usage</div>
              <div class="metric-value" id="memory-usage">0%</div>
              <div class="metric-progress">
                <div class="progress-bar" id="memory-progress"></div>
              </div>
              <div class="metric-details">
                <span id="memory-used">0 MB</span> / 
                <span id="memory-total"><%= Math.round(system.totalMemory / 1024 / 1024) %> MB</span>
              </div>
            </div>
          </div>
          
          <!-- 3D Memory Visualization -->
          <div class="system-visual-container">
            <div id="memory-visualization" class="visualization-3d"></div>
            <!-- 2D Fallback -->
            <div id="memory-visualization-2d" class="fallback-chart-container">
              <div class="fallback-message">
                <i class="fas fa-memory fa-2x"></i>
                <h3>Memory Allocation</h3>
                <p>Visual representation of system memory usage and allocation</p>
              </div>
              <div class="fallback-bars">
                <div class="fallback-bar">
                  <div class="bar-label">Heap Used</div>
                  <div class="bar-wrapper">
                    <div class="bar" style="width: <%= Math.round(system.memoryUsage.heapUsed / system.totalMemory * 100) %>%"></div>
                  </div>
                  <div class="bar-value"><%= Math.round(system.memoryUsage.heapUsed / 1024 / 1024) %> MB</div>
                </div>
                <div class="fallback-bar">
                  <div class="bar-label">Heap Total</div>
                  <div class="bar-wrapper">
                    <div class="bar" style="width: <%= Math.round(system.memoryUsage.heapTotal / system.totalMemory * 100) %>%"></div>
                  </div>
                  <div class="bar-value"><%= Math.round(system.memoryUsage.heapTotal / 1024 / 1024) %> MB</div>
                </div>
                <div class="fallback-bar">
                  <div class="bar-label">RSS</div>
                  <div class="bar-wrapper">
                    <div class="bar" style="width: <%= Math.round(system.memoryUsage.rss / system.totalMemory * 100) %>%"></div>
                  </div>
                  <div class="bar-value"><%= Math.round(system.memoryUsage.rss / 1024 / 1024) %> MB</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-card command-usage">
        <div class="stats-card-header">
          <h2>Command Usage</h2>
        </div>
        <div class="stats-card-body">
          <!-- 3D Command Usage Chart -->
          <div id="command-usage-chart" class="chart-3d-container"></div>
          <!-- 2D Fallback -->
          <div id="command-usage-2d" class="fallback-chart-container">
            <div class="fallback-message">
              <i class="fas fa-terminal fa-2x"></i>
              <h3>Command Usage</h3>
              <p>Most frequently used bot commands</p>
            </div>
            <div class="command-list">
              <div class="command-item">
                <div class="command-name">.ban</div>
                <div class="command-count">124</div>
                <div class="command-bar-wrapper">
                  <div class="command-bar" style="width: 85%"></div>
                </div>
              </div>
              <div class="command-item">
                <div class="command-name">.help</div>
                <div class="command-count">98</div>
                <div class="command-bar-wrapper">
                  <div class="command-bar" style="width: 65%"></div>
                </div>
              </div>
              <div class="command-item">
                <div class="command-name">.role</div>
                <div class="command-count">76</div>
                <div class="command-bar-wrapper">
                  <div class="command-bar" style="width: 50%"></div>
                </div>
              </div>
              <div class="command-item">
                <div class="command-name">.mute</div>
                <div class="command-count">43</div>
                <div class="command-bar-wrapper">
                  <div class="command-bar" style="width: 30%"></div>
                </div>
              </div>
              <div class="command-item">
                <div class="command-name">.blacklist</div>
                <div class="command-count">21</div>
                <div class="command-bar-wrapper">
                  <div class="command-bar" style="width: 15%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot Activity Section -->
    <div class="stats-row">
      <div class="stats-card activity-log">
        <div class="stats-card-header">
          <h2>Recent Activity</h2>
        </div>
        <div class="stats-card-body">
          <div class="activity-timeline">
            <div class="timeline-loading">
              <div class="loading-spinner"></div>
              <p>Loading activity data...</p>
            </div>
            <ul id="activity-log-list" class="activity-list">
              <!-- Activity items will be populated via JavaScript -->
            </ul>
          </div>
        </div>
      </div>

      <div class="stats-card guild-distribution">
        <div class="stats-card-header">
          <h2>Guild Distribution</h2>
        </div>
        <div class="stats-card-body">
          <!-- 3D Guild Distribution Globe -->
          <div id="guild-globe" class="globe-container"></div>
          <!-- 2D Fallback -->
          <div id="guild-distribution-2d" class="fallback-chart-container">
            <div class="fallback-message">
              <i class="fas fa-globe fa-2x"></i>
              <h3>Guild Distribution</h3>
              <p>Geographical distribution of Discord servers</p>
            </div>
            <div class="region-distribution">
              <div class="region-item">
                <div class="region-name">North America</div>
                <div class="region-count"><%= Math.round(serverStats.servers * 0.42) %></div>
                <div class="region-bar-wrapper">
                  <div class="region-bar" style="width: 42%"></div>
                </div>
              </div>
              <div class="region-item">
                <div class="region-name">Europe</div>
                <div class="region-count"><%= Math.round(serverStats.servers * 0.35) %></div>
                <div class="region-bar-wrapper">
                  <div class="region-bar" style="width: 35%"></div>
                </div>
              </div>
              <div class="region-item">
                <div class="region-name">Asia Pacific</div>
                <div class="region-count"><%= Math.round(serverStats.servers * 0.15) %></div>
                <div class="region-bar-wrapper">
                  <div class="region-bar" style="width: 15%"></div>
                </div>
              </div>
              <div class="region-item">
                <div class="region-name">South America</div>
                <div class="region-count"><%= Math.round(serverStats.servers * 0.05) %></div>
                <div class="region-bar-wrapper">
                  <div class="region-bar" style="width: 5%"></div>
                </div>
              </div>
              <div class="region-item">
                <div class="region-name">Other Regions</div>
                <div class="region-count"><%= Math.round(serverStats.servers * 0.03) %></div>
                <div class="region-bar-wrapper">
                  <div class="region-bar" style="width: 3%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WebSocket Status Indicator -->
<div class="websocket-status">
  <div class="status-indicator" id="ws-status-indicator"></div>
  <span id="ws-status-text">Connecting to real-time data...</span>
</div>

<!-- Three.js Script for 3D Visualizations -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r151/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
<script src="/js/admin3d-stats.js"></script>

<!-- Error handling for THREE.js -->
<script>
  // Check if THREE is available
  if (typeof THREE === 'undefined') {
    // Create and display error notification
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-notification';
    errorDiv.innerHTML = `
      <p><strong>Error:</strong> THREE.js library failed to load.</p>
      <p>Switching to 2D mode automatically.</p>
      <p>You can try refreshing the page if you want to use 3D mode.</p>
      <button id="close-error" class="btn">Close</button>
    `;
    document.body.appendChild(errorDiv);
    
    // Add close button functionality
    document.getElementById('close-error').addEventListener('click', function() {
      errorDiv.remove();
    });
    
    // Automatically switch to 2D mode
    setTimeout(function() {
      document.body.classList.add('mode-2d');
      document.getElementById('mode-2d').classList.add('active');
      document.getElementById('mode-3d').classList.remove('active');
    }, 500);
    
    // Log the error
    console.error('THREE.js library not loaded. Switching to 2D mode.');
  }
</script>

<!-- Mode Switching Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle visualization mode switching
    const mode3dBtn = document.getElementById('mode-3d');
    const mode2dBtn = document.getElementById('mode-2d');
    
    if (mode3dBtn && mode2dBtn) {
      // 3D Mode button click
      mode3dBtn.addEventListener('click', function() {
        if (typeof THREE === 'undefined') {
          // Show error if THREE.js is not available
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-notification';
          errorDiv.innerHTML = `
            <p><strong>Error:</strong> 3D visualizations are not available.</p>
            <p>THREE.js library could not be loaded.</p>
            <p>Please refresh the page or try again later.</p>
            <button id="close-3d-error" class="btn">Close</button>
          `;
          document.body.appendChild(errorDiv);
          
          // Add close button functionality
          document.getElementById('close-3d-error').addEventListener('click', function() {
            errorDiv.remove();
          });
          
          return;
        }
        
        // Switch to 3D mode
        document.body.classList.remove('mode-2d');
        mode3dBtn.classList.add('active');
        mode2dBtn.classList.remove('active');
      });
      
      // 2D Mode button click
      mode2dBtn.addEventListener('click', function() {
        // Switch to 2D mode
        document.body.classList.add('mode-2d');
        mode2dBtn.classList.add('active');
        mode3dBtn.classList.remove('active');
      });
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize with system data from server
    const systemData = {
      cpuCount: <%= system.cpuCount %>,
      totalMemory: <%= system.totalMemory %>,
      freeMemory: <%= system.freeMemory %>,
      memoryUsage: {
        rss: <%= system.memoryUsage.rss %>,
        heapTotal: <%= system.memoryUsage.heapTotal %>,
        heapUsed: <%= system.memoryUsage.heapUsed %>,
        external: <%= system.memoryUsage.external %>,
      },
      uptime: {
        days: <%= uptime.days %>,
        hours: <%= uptime.hours %>,
        minutes: <%= uptime.minutes %>,
        seconds: <%= uptime.seconds %>,
        totalSeconds: <%= uptime.totalSeconds %>
      },
      serverStats: {
        servers: <%= serverStats.servers %>,
        users: <%= serverStats.users %>,
        channels: <%= serverStats.channels %>
      }
    };
    
    // Initialize the stats dashboard with initial data
    initStatsVisualizations(systemData);
    
    // Setup refresh button
    document.getElementById('refresh-stats-btn').addEventListener('click', function() {
      refreshStats();
    });
    
    // Setup time period selectors
    document.querySelectorAll('.time-btn').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        updateTimeRange(this.dataset.time);
      });
    });
  });
</script>

