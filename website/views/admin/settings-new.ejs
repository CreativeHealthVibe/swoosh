<!-- Include the admin header partial -->
<%- include('../partials/admin-header', { user: user }) %>

<div class="admin-page-header">
  <div class="header-content">
    <h1><i class="fas fa-cog"></i> Bot Settings</h1>
    <p>Configure bot behavior and administration settings</p>
  </div>
</div>

<!-- Alert messages -->
<% if (messages.success) { %>
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <%= messages.success %>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<% if (messages.error) { %>
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  <%= messages.error %>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<!-- Settings content -->
<div class="settings-container">
  <!-- Navigation tabs -->
  <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= tab === 'general' ? 'active' : '' %>" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
        <i class="fas fa-sliders-h"></i> General
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= tab === 'logging' ? 'active' : '' %>" id="logging-tab" data-bs-toggle="tab" data-bs-target="#logging" type="button" role="tab">
        <i class="fas fa-list-alt"></i> Logging
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= tab === 'admins' ? 'active' : '' %>" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">
        <i class="fas fa-users-cog"></i> Admins
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= tab === 'messages' ? 'active' : '' %>" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab">
        <i class="fas fa-comment-dots"></i> Messages
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= tab === 'news' ? 'active' : '' %>" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" role="tab">
        <i class="fas fa-newspaper"></i> News
      </button>
    </li>
  </ul>
  
  <div class="tab-content pt-4" id="settingsTabContent">
    <!-- General Settings Tab -->
    <div class="tab-pane fade <%= tab === 'general' ? 'show active' : '' %>" id="general" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">Bot Configuration</h5>
        </div>
        <div class="card-body">
          <form id="botSettingsForm" action="/admin/settings/update" method="POST">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="prefix" class="form-label">Command Prefix</label>
                  <input type="text" class="form-control" id="prefix" name="prefix" value="<%= config.prefix %>" maxlength="3">
                  <small class="form-text text-muted">Character used before commands (e.g., .help)</small>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="embedColor" class="form-label">Embed Color</label>
                  <input type="color" class="form-control form-control-color" id="embedColor" name="embedColor" value="<%= config.embedColor %>">
                  <small class="form-text text-muted">Color used for message embeds</small>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div class="mb-3">
                  <label for="ticketCategory" class="form-label">Ticket Category</label>
                  <input type="text" class="form-control" id="ticketCategory" name="ticketCategory" value="<%= config.ticketCategory %>">
                  <small class="form-text text-muted">Discord category for new tickets</small>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div class="mb-3">
                  <label for="logChannelId" class="form-label">Log Channel ID</label>
                  <input type="text" class="form-control" id="logChannelId" name="logChannelId" value="<%= config.logChannelId %>" placeholder="Discord Channel ID">
                  <small class="form-text text-muted">Main channel for sending log messages</small>
                </div>
              </div>
            </div>
            
            <h5 class="mt-4 mb-3">Validation Settings</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="bountyMin" class="form-label">Minimum Bounty</label>
                  <input type="number" class="form-control" id="bountyMin" name="bountyMin" value="<%= config.validation.bountyMin %>" min="1">
                  <small class="form-text text-muted">Minimum allowed bounty amount</small>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="bountyMax" class="form-label">Maximum Bounty</label>
                  <input type="number" class="form-control" id="bountyMax" name="bountyMax" value="<%= config.validation.bountyMax %>" min="100">
                  <small class="form-text text-muted">Maximum allowed bounty amount</small>
                </div>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary mt-3">
              <i class="fas fa-save me-2"></i> Save All Changes
            </button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Logging Settings Tab -->
    <div class="tab-pane fade <%= tab === 'logging' ? 'show active' : '' %>" id="logging" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">Logging Channels</h5>
        </div>
        <div class="card-body">
          <form action="/admin/settings/update" method="POST">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="deletedMessages" class="form-label">Deleted Messages</label>
                  <input type="text" class="form-control" id="deletedMessages" name="deletedMessages" 
                         value="<%= config.loggingChannels.deletedMessages %>" placeholder="Channel ID">
                  <small class="form-text text-muted">Channel for logging deleted messages</small>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="ticketTranscripts" class="form-label">Ticket Transcripts</label>
                  <input type="text" class="form-control" id="ticketTranscripts" name="ticketTranscripts" 
                         value="<%= config.loggingChannels.ticketTranscripts %>" placeholder="Channel ID">
                  <small class="form-text text-muted">Channel for storing ticket transcripts</small>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="commandUsage" class="form-label">Command Usage</label>
                  <input type="text" class="form-control" id="commandUsage" name="commandUsage" 
                         value="<%= config.loggingChannels.commandUsage %>" placeholder="Channel ID">
                  <small class="form-text text-muted">Channel for logging command usage</small>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="botStatus" class="form-label">Bot Status</label>
                  <input type="text" class="form-control" id="botStatus" name="botStatus" 
                         value="<%= config.loggingChannels.botStatus %>" placeholder="Channel ID">
                  <small class="form-text text-muted">Channel for bot status updates</small>
                </div>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary mt-3">
              <i class="fas fa-save me-2"></i> Save Logging Settings
            </button>
          </form>
        </div>
      </div>
      
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="card-title">Log Management</h5>
        </div>
        <div class="card-body">
          <p>View and manage bot logs to monitor activity and troubleshoot issues.</p>
          <a href="/admin/logs" class="btn btn-primary">
            <i class="fas fa-list me-2"></i> View System Logs
          </a>
        </div>
      </div>
    </div>
    
    <!-- Admin Users Tab -->
    <div class="tab-pane fade <%= tab === 'admins' ? 'show active' : '' %>" id="admins" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">Admin Access</h5>
        </div>
        <div class="card-body">
          <h6 class="mb-3">Discord Admin Users</h6>
          <p class="text-muted mb-4">Users with full access to the admin dashboard</p>
          
          <div id="adminUsers" class="admin-users-list mb-4">
            <% if (adminUsers && adminUsers.length > 0) { %>
              <% adminUsers.forEach(userId => { %>
                <div class="admin-user-item">
                  <div class="admin-user-info">
                    <div class="admin-user-id"><%= userId %></div>
                    <div class="admin-user-role">Full Administrator</div>
                  </div>
                  <form action="/admin/users/remove" method="POST" class="d-inline">
                    <input type="hidden" name="userId" value="<%= userId %>">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to remove this admin user?')">
                      <i class="fas fa-times"></i> Remove
                    </button>
                  </form>
                </div>
              <% }); %>
            <% } else { %>
              <div class="alert alert-info">No Discord admin users have been added yet.</div>
            <% } %>
          </div>
          
          <div class="admin-action-section">
            <form action="/admin/users/add" method="POST" class="admin-add-form">
              <div class="row g-3 align-items-end">
                <div class="col-md-5">
                  <label for="userId" class="form-label">Discord User ID</label>
                  <input type="text" class="form-control" id="userId" name="userId" placeholder="Enter Discord ID" required pattern="^\d{17,19}$">
                </div>
                <div class="col-md-5">
                  <label for="comment" class="form-label">User Description</label>
                  <input type="text" class="form-control" id="comment" name="comment" placeholder="e.g. Moderator, Developer" required>
                </div>
                <div class="col-md-2">
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-plus-circle"></i> Add Admin
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <% if (localAdminUsers && localAdminUsers.length > 0) { %>
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="card-title">Local Admin Users</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% localAdminUsers.forEach(user => { %>
                <tr>
                  <td><%= user.username %></td>
                  <td><%= user.email %></td>
                  <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A' %></td>
                  <td>
                    <form action="/admin/localusers/remove" method="POST" class="d-inline">
                      <input type="hidden" name="id" value="<%= user.id %>">
                      <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to remove this admin user?')">
                        <i class="fas fa-times"></i> Remove
                      </button>
                    </form>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <% } %>
    </div>
    
    <!-- Messages Tab -->
    <div class="tab-pane fade <%= tab === 'messages' ? 'show active' : '' %>" id="messages" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">✉️ Send Bot Messages</h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Send messages as the bot to any channel in your servers</p>
          
          <form id="sendMessageForm" action="/admin/settings/send-message" method="POST">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="serverSelect" class="form-label">Server</label>
                  <select class="form-select" id="serverSelect" name="serverId" required>
                    <option value="" selected disabled>Select a server</option>
                    <% if (typeof servers !== 'undefined' && servers && servers.length > 0) { %>
                      <% servers.forEach(server => { %>
                        <option value="<%= server.id %>"><%= server.name %> (<%= server.memberCount %> members)</option>
                      <% }); %>
                    <% } else { %>
                      <option value="" disabled>No servers available</option>
                    <% } %>
                  </select>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="channelSelect" class="form-label">Channel</label>
                  <select class="form-select" id="channelSelect" name="channelId" required disabled>
                    <option value="" selected disabled>Select a server first</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="messageContent" class="form-label">Message Content</label>
              <textarea class="form-control" id="messageContent" name="messageContent" rows="4" required placeholder="Enter your message here..."></textarea>
            </div>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="embedMessage" name="embedMessage">
              <label class="form-check-label" for="embedMessage">
                Send as embed
              </label>
            </div>
            
            <div class="text-end">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-robot me-2"></i> Send as Bot
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- News Tab -->
    <div class="tab-pane fade <%= tab === 'news' ? 'show active' : '' %>" id="news" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">📢 News Updates</h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Send news updates to the configured news channel</p>
          
          <form id="newsForm" action="/admin/settings/send-news" method="POST">
            <div class="mb-3">
              <label for="newsTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="newsTitle" name="newsTitle" required maxlength="100" placeholder="Announcement title">
            </div>
            
            <div class="mb-3">
              <label for="newsContent" class="form-label">Content</label>
              <textarea class="form-control" id="newsContent" name="newsContent" rows="4" required placeholder="News content with detailed information..."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="newsColor" class="form-label">Color</label>
                  <input type="color" class="form-control form-control-color" id="newsColor" name="newsColor" value="#5865F2">
                  <small class="form-text text-muted">Color for the news embed</small>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="newsImage" class="form-label">Image URL (Optional)</label>
                  <input type="url" class="form-control" id="newsImage" name="newsImage" placeholder="https://example.com/image.png">
                  <small class="form-text text-muted">Image to display with the news</small>
                </div>
              </div>
            </div>
            
            <div class="text-end">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i> Send News
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="card-title">News Channel Configuration</h5>
        </div>
        <div class="card-body">
          <p>Current news channel: <code><%= config.newsChannel || 'Not configured' %></code></p>
          <p class="text-muted">To change the news channel, update the <code>newsChannel</code> property in the <code>config.js</code> file.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .admin-users-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .admin-user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background-color: var(--bs-light);
    border-radius: 8px;
    border-left: 4px solid #5865F2;
  }
  
  .admin-user-info {
    display: flex;
    flex-direction: column;
  }
  
  .admin-user-id {
    font-weight: 600;
    font-family: 'Courier New', monospace;
  }
  
  .admin-user-role {
    font-size: 0.85rem;
    color: var(--bs-primary);
  }
  
  .admin-action-section {
    border-top: 1px solid var(--bs-gray-200);
    padding-top: 20px;
  }
  
  .admin-add-form {
    background-color: var(--bs-light);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
</style>

<script>
  // Real-time validation for bounty values
  document.addEventListener('DOMContentLoaded', function() {
    const bountyMinInput = document.getElementById('bountyMin');
    const bountyMaxInput = document.getElementById('bountyMax');
    
    if (bountyMinInput && bountyMaxInput) {
      bountyMinInput.addEventListener('change', function(e) {
        const min = parseInt(e.target.value);
        const max = parseInt(bountyMaxInput.value);
        
        if (min >= max) {
          alert('Minimum bounty must be less than maximum bounty');
          e.target.value = <%= config.validation.bountyMin %>;
        }
      });
      
      bountyMaxInput.addEventListener('change', function(e) {
        const max = parseInt(e.target.value);
        const min = parseInt(bountyMinInput.value);
        
        if (max <= min) {
          alert('Maximum bounty must be greater than minimum bounty');
          e.target.value = <%= config.validation.bountyMax %>;
        }
      });
    }
    
    // Form submission confirmation
    const botSettingsForm = document.getElementById('botSettingsForm');
    if (botSettingsForm) {
      botSettingsForm.addEventListener('submit', function(e) {
        if (!confirm('Are you sure you want to update the bot configuration? This will restart the bot.')) {
          e.preventDefault();
        }
      });
    }
    
    // Server/Channel Selection Logic for Message Sending
    const serverSelect = document.getElementById('serverSelect');
    const channelSelect = document.getElementById('channelSelect');
    
    if (serverSelect && channelSelect) {
      serverSelect.addEventListener('change', function() {
        const serverId = this.value;
        channelSelect.disabled = true;
        channelSelect.innerHTML = '<option value="" selected disabled>Loading channels...</option>';
        
        if (serverId) {
          // Fetch channels for the selected server
          fetch(`/admin/api/servers/${serverId}/channels`)
            .then(response => response.json())
            .then(channels => {
              channelSelect.innerHTML = '<option value="" selected disabled>Select a channel</option>';
              
              if (channels && channels.length > 0) {
                channels.forEach(channel => {
                  const option = document.createElement('option');
                  option.value = channel.id;
                  option.textContent = `#${channel.name}`;
                  channelSelect.appendChild(option);
                });
                channelSelect.disabled = false;
              } else {
                channelSelect.innerHTML = '<option value="" selected disabled>No text channels available</option>';
              }
            })
            .catch(error => {
              console.error('Error fetching channels:', error);
              channelSelect.innerHTML = '<option value="" selected disabled>Error loading channels</option>';
            });
        } else {
          channelSelect.innerHTML = '<option value="" selected disabled>Select a server first</option>';
        }
      });
    }
  });
</script>

<!-- Include the admin footer partial -->
<%- include('../partials/admin-footer') %>